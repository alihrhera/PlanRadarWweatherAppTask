package hrhera.ali.malware_or_debug

import androidx.lifecycle.testing.TestLifecycleOwner
import androidx.lifecycle.SavedStateHandle
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.StandardTestDispatcher
import kotlinx.coroutines.test.resetMain
import kotlinx.coroutines.test.runTest
import kotlinx.coroutines.test.setMain
import org.junit.After
import org.junit.Assert.*
import org.junit.Before
import org.junit.Test

@OptIn(ExperimentalCoroutinesApi::class)
class SecurityWarningViewModelTest {

    private lateinit var viewModel: SecurityWarningViewModel
    private lateinit var savedStateHandle: SavedStateHandle

    @Before
    fun setup() {
         val testDispatcher = StandardTestDispatcher()
        Dispatchers.setMain(testDispatcher)
        savedStateHandle = SavedStateHandle()
        viewModel = TestSecurityWarningViewModel(savedStateHandle)
    }

    @After
    fun tearDown() {
        Dispatchers.resetMain()
    }
    @Test
    fun `transitionToCounter starts timer and updates state`() = runTest {
        viewModel.transitionToCounter(15) { }
        assertEquals(0, viewModel.state.value.secondsLeft)
        viewModel.state.value.secondsLeft.let { seconds ->
            assertTrue(seconds in 0..15)
        }
    }

    @Test
    fun `onPause saves remaining seconds to savedStateHandle`() {
        viewModel.transitionToCounter(15) {}
        val owner = TestLifecycleOwner()
        viewModel.onPause(owner)
        val saved = savedStateHandle.get<Long>("secondsLeft")
        assertNotNull(saved)
    }

    @Test
    fun `onResume restores timer from savedStateHandle`() {
        savedStateHandle["secondsLeft"] = 10L
        viewModel.transitionToCounter(15) {}
        val owner = TestLifecycleOwner()
        viewModel.onResume(owner)
        assertTrue(viewModel.state.value.secondsLeft >= 0)
    }

    @Test
    fun `onDestroy cancels timer`() {
        viewModel.transitionToCounter(15) {}
        val owner = TestLifecycleOwner()
        viewModel.onDestroy(owner)
        assertNotNull(viewModel.state.value)
    }
}
