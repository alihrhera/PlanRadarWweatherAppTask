package hrhera.ali.malware_or_debug

import androidx.compose.runtime.State
import androidx.compose.runtime.mutableStateOf
import androidx.lifecycle.DefaultLifecycleObserver
import androidx.lifecycle.LifecycleOwner
import androidx.lifecycle.SavedStateHandle
import androidx.lifecycle.ViewModel
import dagger.hilt.android.lifecycle.HiltViewModel
import hrhera.ali.core.Counter
import javax.inject.Inject

@HiltViewModel
class SecurityWarningViewModel @Inject constructor(
    private val savedStateHandle: SavedStateHandle
) : ViewModel(), DefaultLifecycleObserver {
    private val _state = mutableStateOf(SecurityWarningState(0))
    val state: State<SecurityWarningState> = _state
    private var timer: Counter? = null
    fun transitionToCounter(time: Int, onCounterFinish: () -> Unit) {
        timer = Counter(
            onCounterFinish = onCounterFinish,
            onTimeChange = {
                _state.value = SecurityWarningState(it.toInt() / 1000)
            },
        )
        timer?.start(time)
    }

    override fun onPause(owner: LifecycleOwner) {
        super.onPause(owner)
        timer?.onPause {
            savedStateHandle["secondsLeft"] = it
        }
    }


    override fun onDestroy(owner: LifecycleOwner) {
        super.onDestroy(owner)
        timer?.cancel()
    }

    override fun onResume(owner: LifecycleOwner) {
        super.onResume(owner)
        val remainingTime = savedStateHandle.get<Long>("secondsLeft") ?: -1L
        if (remainingTime > -1) {
            timer?.start((remainingTime / 1000).toInt())
        }
    }

}